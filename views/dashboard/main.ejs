<% layout('layouts/boilerplate') %>

<div class="container-fluid">
  <div class="row">
    <%- include('../partials/products/sidebar') %>

    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <!-- KPI Cards -->
      <div class="row my-4 g-3 justify-content-between kpi-row">
        <% const cards = [ { title: "Total Products", value: totalProducts }, { title: "Total Stock", value: totalStock
        }, { title: "Total Value", value: `₱${totalValue}` }, { title: "Total Sales", value: `₱${totalSales}` }, {
        title: "Total Profit", value: `₱${totalProfit}` }, ]; %> <% cards.forEach(card => { %>
        <div class="col kpi-card">
          <div class="card text-center shadow-sm h-100">
            <div class="card-body">
              <h5 class="card-title"><%= card.title %></h5>
              <p class="card-text display-6"><%= card.value %></p>
            </div>
          </div>
        </div>
        <% }); %>
      </div>

      <!-- Charts Row -->
      <div class="row my-4 g-3">
        <div class="col-12 col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title">Sales & Profits Overview</h5>
                <div>
                  <select id="chartPeriod" class="form-select form-select-sm d-inline-block w-auto">
                    <option value="weekly" selected>Weekly</option>
                    <option value="monthly">Monthly</option>
                  </select>
                  <div class="btn-group ms-2">
                    <button class="btn btn-outline-primary btn-sm active" id="btnSales">Sales</button>
                    <button class="btn btn-outline-primary btn-sm" id="btnProfit">Profits</button>
                  </div>
                </div>
              </div>
              <canvas id="salesProfitChart" height="150"></canvas>
            </div>
          </div>
        </div>

        <!-- Recent Sales -->
        <div class="col-12 col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <h5 class="card-title">Recent Products Sold</h5>
              <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                  <thead class="table-dark">
                    <tr>
                      <th>Product</th>
                      <th>Category</th>
                      <th>Qty</th>
                      <th>Price</th>
                      <th>Subtotal</th>
                      <th>Date</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (recentSales.length) { %> <% recentSales.forEach(sale => { %>
                    <tr>
                      <td><%= sale.productDetails.name %></td>
                      <td class="text-capitalize"><%= sale.productDetails.category %></td>
                      <td><%= sale.products.quantity %></td>
                      <td>₱<%= sale.products.price.toFixed(2) %></td>
                      <td>₱<%= sale.products.subtotal.toFixed(2) %></td>
                      <td><%= new Date(sale.date).toLocaleDateString('en-US') %></td>
                    </tr>
                    <% }); %> <% } else { %>
                    <tr>
                      <td colspan="6" class="text-center text-muted">No recent sales.</td>
                    </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Stocks -->
      <div class="row my-4">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Recent Stocks</h5>
              <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                  <thead class="table-dark">
                    <tr>
                      <th>Name</th>
                      <th>Price</th>
                      <th>Stock</th>
                      <th>Category</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% recentProducts.forEach(p => { %>
                    <tr>
                      <td><%= p.name %></td>
                      <td>₱<%= p.price.toFixed(2) %></td>
                      <td><%= p.stock %></td>
                      <td class="text-capitalize"><%= p.category %></td>
                    </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
  const ctx = document.getElementById("salesProfitChart");
  let chart;
  let currentType = "sales";
  let currentPeriod = "weekly";

  async function fetchChartData() {
    const res = await fetch(`/dashboard/chart-data?period=${currentPeriod}`);
    return await res.json();
  }

  async function renderChart() {
    const { labels, salesData, profitData, dateRangeLabel } = await fetchChartData();
    const dataset = currentType === "sales" ? salesData : profitData;

    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          {
            label: currentType === "sales" ? "Sales (₱)" : "Profit (₱)",
            data: dataset,
            backgroundColor: "#599FC5",
            borderColor: "#599FC5",
            borderWidth: 1,
          },
        ],
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: `Sales & Profit Overview (${dateRangeLabel})`,
            font: { size: 16, weight: "bold" },
          },
          legend: { display: false },
        },
        scales: { y: { beginAtZero: true } },
      },
    });
  }

  document.getElementById("chartPeriod").addEventListener("change", (e) => {
    currentPeriod = e.target.value;
    renderChart();
  });

  document.getElementById("btnSales").addEventListener("click", () => {
    currentType = "sales";
    toggleActive("btnSales");
    renderChart();
  });

  document.getElementById("btnProfit").addEventListener("click", () => {
    currentType = "profit";
    toggleActive("btnProfit");
    renderChart();
  });

  function toggleActive(id) {
    document.getElementById("btnSales").classList.remove("active");
    document.getElementById("btnProfit").classList.remove("active");
    document.getElementById(id).classList.add("active");
  }

  renderChart();
</script>
